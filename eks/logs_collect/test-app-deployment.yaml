apiVersion: v1
kind: Namespace
metadata:
  name: logs-collect
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: log-generator
  namespace: logs-collect
  labels:
    app: log-generator
spec:
  replicas: 2
  selector:
    matchLabels:
      app: log-generator
  template:
    metadata:
      labels:
        app: log-generator
    spec:
      containers:
      - name: log-generator
        image: nginx:alpine
        ports:
        - containerPort: 80
        env:
        - name: LOG_LEVEL
          value: "info"
        - name: APP_NAME
          value: "log-generator"
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: web-content
          mountPath: /usr/share/nginx/html
        - name: log-script
          mountPath: /usr/local/bin/log-generator.sh
          subPath: log-generator.sh
        command: ["/bin/sh"]
        args: ["-c", "chmod +x /usr/local/bin/log-generator.sh && /usr/local/bin/log-generator.sh & nginx -g 'daemon off;'"]
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
      - name: web-content
        configMap:
          name: web-content
      - name: log-script
        configMap:
          name: log-script
          defaultMode: 0755
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: logs-collect
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }
    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;
        
        log_format json_combined escape=json
        '{'
          '"timestamp":"$time_iso8601",'
          '"remote_addr":"$remote_addr",'
          '"remote_user":"$remote_user",'
          '"request":"$request",'
          '"status": "$status",'
          '"body_bytes_sent":"$body_bytes_sent",'
          '"request_time":"$request_time",'
          '"http_referrer":"$http_referer",'
          '"http_user_agent":"$http_user_agent",'
          '"app_name":"log-generator",'
          '"log_level":"info",'
          '"request_id":"req-$request_id"'
        '}';
        
        access_log /var/log/nginx/access.log json_combined;
        error_log /var/log/nginx/error.log warn;
        
        server {
            listen 80;
            server_name _;
            
            # é™æ€æ–‡ä»¶æœåŠ¡
            location / {
                root /usr/share/nginx/html;
                index index.html;
                try_files $uri $uri/ /index.html;
            }
            
            # APIç«¯ç‚¹
            location /api/health {
                return 200 '{"status":"healthy","app":"log-generator","timestamp":"$time_iso8601"}';
                add_header Content-Type application/json;
                add_header Access-Control-Allow-Origin *;
            }
            
            location /api/trigger-log {
                access_log /var/log/nginx/access.log json_combined;
                return 200 '{"message":"Log triggered successfully","timestamp":"$time_iso8601","level":"info","request_id":"req-$request_id"}';
                add_header Content-Type application/json;
                add_header Access-Control-Allow-Origin *;
            }
            
            location /api/trigger-error {
                access_log /var/log/nginx/access.log json_combined;
                return 500 '{"message":"Simulated error occurred","timestamp":"$time_iso8601","level":"error","request_id":"req-$request_id"}';
                add_header Content-Type application/json;
                add_header Access-Control-Allow-Origin *;
            }
            
            location /api/trigger-warning {
                access_log /var/log/nginx/access.log json_combined;
                return 200 '{"message":"Warning condition detected","timestamp":"$time_iso8601","level":"warn","request_id":"req-$request_id"}';
                add_header Content-Type application/json;
                add_header Access-Control-Allow-Origin *;
            }
            
            location /api/bulk-logs {
                access_log /var/log/nginx/access.log json_combined;
                return 200 '{"message":"Bulk logs generated","timestamp":"$time_iso8601","level":"info","count":10,"request_id":"req-$request_id"}';
                add_header Content-Type application/json;
                add_header Access-Control-Allow-Origin *;
            }
            
            # å…¼å®¹æ—§ç«¯ç‚¹
            location /health {
                return 200 '{"status":"healthy","app":"log-generator"}';
                add_header Content-Type application/json;
            }
            
            location /logs {
                return 200 '{"message":"Log endpoint accessed","timestamp":"$time_iso8601","level":"info"}';
                add_header Content-Type application/json;
            }
        }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-content
  namespace: logs-collect
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>EKS æ—¥å¿—é‡‡é›†æµ‹è¯•ç³»ç»Ÿ</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }
            
            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                overflow: hidden;
            }
            
            .header {
                background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                color: white;
                padding: 30px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            }
            
            .header p {
                font-size: 1.2em;
                opacity: 0.9;
            }
            
            .content {
                padding: 40px;
            }
            
            .status-section {
                background: #f8f9fa;
                border-radius: 10px;
                padding: 25px;
                margin-bottom: 30px;
                border-left: 5px solid #28a745;
            }
            
            .status-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding: 10px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            
            .status-item:last-child {
                margin-bottom: 0;
            }
            
            .status-label {
                font-weight: 600;
                color: #333;
            }
            
            .status-value {
                color: #28a745;
                font-weight: 500;
            }
            
            .controls-section {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .control-card {
                background: white;
                border-radius: 10px;
                padding: 25px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.08);
                border: 1px solid #e9ecef;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            
            .control-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            }
            
            .control-card h3 {
                color: #333;
                margin-bottom: 15px;
                font-size: 1.3em;
            }
            
            .control-card p {
                color: #666;
                margin-bottom: 20px;
                line-height: 1.5;
            }
            
            .btn {
                width: 100%;
                padding: 12px 20px;
                border: none;
                border-radius: 8px;
                font-size: 1em;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .btn-success {
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
            }
            
            .btn-warning {
                background: linear-gradient(135deg, #ffc107, #fd7e14);
                color: white;
            }
            
            .btn-danger {
                background: linear-gradient(135deg, #dc3545, #e83e8c);
                color: white;
            }
            
            .btn-info {
                background: linear-gradient(135deg, #17a2b8, #6f42c1);
                color: white;
            }
            
            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }
            
            .btn:active {
                transform: translateY(0);
            }
            
            .logs-section {
                background: #f8f9fa;
                border-radius: 10px;
                padding: 25px;
                margin-top: 30px;
            }
            
            .logs-section h3 {
                color: #333;
                margin-bottom: 20px;
                font-size: 1.5em;
            }
            
            .log-output {
                background: #2d3748;
                color: #e2e8f0;
                padding: 20px;
                border-radius: 8px;
                font-family: 'Courier New', monospace;
                font-size: 0.9em;
                max-height: 300px;
                overflow-y: auto;
                white-space: pre-wrap;
                line-height: 1.4;
            }
            
            .log-entry {
                margin-bottom: 8px;
                padding: 5px 0;
                border-bottom: 1px solid #4a5568;
            }
            
            .log-entry:last-child {
                border-bottom: none;
                margin-bottom: 0;
            }
            
            .timestamp {
                color: #90cdf4;
            }
            
            .log-level-info {
                color: #68d391;
            }
            
            .log-level-warn {
                color: #fbb040;
            }
            
            .log-level-error {
                color: #fc8181;
            }
            
            .clear-logs {
                margin-top: 15px;
                padding: 8px 16px;
                background: #4a5568;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.9em;
            }
            
            .clear-logs:hover {
                background: #2d3748;
            }
            
            .footer {
                background: #343a40;
                color: white;
                text-align: center;
                padding: 20px;
                font-size: 0.9em;
            }
            
            .loading {
                opacity: 0.6;
                pointer-events: none;
            }
            
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
            
            .pulse {
                animation: pulse 1s infinite;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ğŸš€ EKS æ—¥å¿—é‡‡é›†æµ‹è¯•ç³»ç»Ÿ</h1>
                <p>AWS EKS + OpenSearch + Fluent-bit æ—¥å¿—é‡‡é›†æ¼”ç¤º</p>
            </div>
            
            <div class="content">
                <div class="status-section">
                    <h3 style="margin-bottom: 20px; color: #333;">ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
                    <div class="status-item">
                        <span class="status-label">åº”ç”¨çŠ¶æ€</span>
                        <span class="status-value" id="app-status">æ£€æŸ¥ä¸­...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">é›†ç¾¤åç§°</span>
                        <span class="status-value">logs-collect-cluster</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Kubernetesç‰ˆæœ¬</span>
                        <span class="status-value">1.33</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">æ—¥å¿—é‡‡é›†</span>
                        <span class="status-value">Fluent-bit</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">æ—¥å¿—å­˜å‚¨</span>
                        <span class="status-value">OpenSearch</span>
                    </div>
                </div>
                
                <div class="controls-section">
                    <div class="control-card">
                        <h3>âœ… æ­£å¸¸æ—¥å¿—</h3>
                        <p>è§¦å‘ä¸€æ¡INFOçº§åˆ«çš„æ­£å¸¸æ—¥å¿—ï¼Œç”¨äºæµ‹è¯•åŸºæœ¬çš„æ—¥å¿—é‡‡é›†åŠŸèƒ½ã€‚</p>
                        <button class="btn btn-success" onclick="triggerLog('info')">ç”ŸæˆINFOæ—¥å¿—</button>
                    </div>
                    
                    <div class="control-card">
                        <h3>âš ï¸ è­¦å‘Šæ—¥å¿—</h3>
                        <p>è§¦å‘ä¸€æ¡WARNçº§åˆ«çš„è­¦å‘Šæ—¥å¿—ï¼Œç”¨äºæµ‹è¯•è­¦å‘Šçº§åˆ«çš„æ—¥å¿—å¤„ç†ã€‚</p>
                        <button class="btn btn-warning" onclick="triggerLog('warn')">ç”ŸæˆWARNæ—¥å¿—</button>
                    </div>
                    
                    <div class="control-card">
                        <h3>âŒ é”™è¯¯æ—¥å¿—</h3>
                        <p>è§¦å‘ä¸€æ¡ERRORçº§åˆ«çš„é”™è¯¯æ—¥å¿—ï¼Œç”¨äºæµ‹è¯•é”™è¯¯å¤„ç†å’Œå‘Šè­¦åŠŸèƒ½ã€‚</p>
                        <button class="btn btn-danger" onclick="triggerLog('error')">ç”ŸæˆERRORæ—¥å¿—</button>
                    </div>
                    
                    <div class="control-card">
                        <h3>ğŸ“¦ æ‰¹é‡æ—¥å¿—</h3>
                        <p>ä¸€æ¬¡æ€§ç”Ÿæˆå¤šæ¡æ—¥å¿—ï¼Œç”¨äºæµ‹è¯•é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ—¥å¿—é‡‡é›†æ€§èƒ½ã€‚</p>
                        <button class="btn btn-info" onclick="triggerBulkLogs()">ç”Ÿæˆæ‰¹é‡æ—¥å¿—</button>
                    </div>
                </div>
                
                <div class="logs-section">
                    <h3>ğŸ“ å®æ—¶æ—¥å¿—è¾“å‡º</h3>
                    <div class="log-output" id="log-output">
                        <div class="log-entry">
                            <span class="timestamp">[ç³»ç»Ÿå¯åŠ¨]</span> 
                            <span class="log-level-info">INFO</span> 
                            æ—¥å¿—é‡‡é›†æµ‹è¯•ç³»ç»Ÿå·²å¯åŠ¨ï¼Œç­‰å¾…è§¦å‘æ—¥å¿—...
                        </div>
                    </div>
                    <button class="clear-logs" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                </div>
            </div>
            
            <div class="footer">
                <p>ğŸ—ï¸ AWS EKS 1.33 + OpenSearch + Fluent-bit | æ—¥å¿—é‡‡é›†æ¼”ç¤ºç³»ç»Ÿ</p>
                <p>Powered by Kubernetes & AWS</p>
            </div>
        </div>
        
        <script>
            let logCounter = 1;
            
            // æ£€æŸ¥åº”ç”¨çŠ¶æ€
            async function checkStatus() {
                try {
                    const response = await fetch('/api/health');
                    const data = await response.json();
                    document.getElementById('app-status').textContent = 'ğŸŸ¢ è¿è¡Œæ­£å¸¸';
                    document.getElementById('app-status').style.color = '#28a745';
                } catch (error) {
                    document.getElementById('app-status').textContent = 'ğŸ”´ è¿æ¥å¤±è´¥';
                    document.getElementById('app-status').style.color = '#dc3545';
                }
            }
            
            // æ·»åŠ æ—¥å¿—åˆ°è¾“å‡ºåŒºåŸŸ
            function addLogEntry(level, message, response = null) {
                const logOutput = document.getElementById('log-output');
                const timestamp = new Date().toISOString();
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                let levelClass = 'log-level-info';
                let levelIcon = 'â„¹ï¸';
                
                switch(level) {
                    case 'warn':
                        levelClass = 'log-level-warn';
                        levelIcon = 'âš ï¸';
                        break;
                    case 'error':
                        levelClass = 'log-level-error';
                        levelIcon = 'âŒ';
                        break;
                    case 'info':
                    default:
                        levelClass = 'log-level-info';
                        levelIcon = 'âœ…';
                        break;
                }
                
                let logContent = `<span class="timestamp">[${timestamp}]</span> <span class="${levelClass}">${levelIcon} ${level.toUpperCase()}</span> ${message}`;
                
                if (response) {
                    logContent += `\n    å“åº”: ${JSON.stringify(response, null, 2)}`;
                }
                
                logEntry.innerHTML = logContent;
                logOutput.appendChild(logEntry);
                logOutput.scrollTop = logOutput.scrollHeight;
                
                logCounter++;
            }
            
            // è§¦å‘æ—¥å¿—
            async function triggerLog(level) {
                const button = event.target;
                button.classList.add('loading', 'pulse');
                button.disabled = true;
                
                try {
                    let endpoint = '/api/trigger-log';
                    let message = `è§¦å‘ ${level.toUpperCase()} çº§åˆ«æ—¥å¿—`;
                    
                    switch(level) {
                        case 'warn':
                            endpoint = '/api/trigger-warning';
                            message = 'è§¦å‘è­¦å‘Šæ—¥å¿— - æ£€æµ‹åˆ°æ½œåœ¨é—®é¢˜';
                            break;
                        case 'error':
                            endpoint = '/api/trigger-error';
                            message = 'è§¦å‘é”™è¯¯æ—¥å¿— - æ¨¡æ‹Ÿç³»ç»Ÿé”™è¯¯';
                            break;
                        case 'info':
                        default:
                            endpoint = '/api/trigger-log';
                            message = 'è§¦å‘ä¿¡æ¯æ—¥å¿— - æ­£å¸¸æ“ä½œè®°å½•';
                            break;
                    }
                    
                    const response = await fetch(endpoint);
                    const data = await response.json();
                    
                    addLogEntry(level, message, data);
                    
                    // æ¨¡æ‹Ÿé¢å¤–çš„åº”ç”¨æ—¥å¿—
                    setTimeout(() => {
                        addLogEntry('info', `æ—¥å¿—å·²å‘é€åˆ° Fluent-bit è¿›è¡Œé‡‡é›†å¤„ç†`);
                    }, 500);
                    
                } catch (error) {
                    addLogEntry('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
                } finally {
                    button.classList.remove('loading', 'pulse');
                    button.disabled = false;
                }
            }
            
            // è§¦å‘æ‰¹é‡æ—¥å¿—
            async function triggerBulkLogs() {
                const button = event.target;
                button.classList.add('loading', 'pulse');
                button.disabled = true;
                
                try {
                    addLogEntry('info', 'å¼€å§‹ç”Ÿæˆæ‰¹é‡æ—¥å¿—...');
                    
                    // å¹¶å‘å‘é€å¤šä¸ªè¯·æ±‚
                    const promises = [];
                    for (let i = 0; i < 5; i++) {
                        promises.push(fetch('/api/bulk-logs'));
                        promises.push(fetch('/api/trigger-log'));
                        promises.push(fetch('/api/trigger-warning'));
                    }
                    
                    const responses = await Promise.all(promises);
                    
                    addLogEntry('info', `æ‰¹é‡æ—¥å¿—ç”Ÿæˆå®Œæˆ - å…±å‘é€ ${promises.length} ä¸ªè¯·æ±‚`);
                    addLogEntry('info', 'æ‰€æœ‰æ—¥å¿—å·²æäº¤åˆ° Fluent-bit é˜Ÿåˆ—');
                    
                } catch (error) {
                    addLogEntry('error', `æ‰¹é‡æ—¥å¿—ç”Ÿæˆå¤±è´¥: ${error.message}`);
                } finally {
                    button.classList.remove('loading', 'pulse');
                    button.disabled = false;
                }
            }
            
            // æ¸…ç©ºæ—¥å¿—
            function clearLogs() {
                const logOutput = document.getElementById('log-output');
                logOutput.innerHTML = `
                    <div class="log-entry">
                        <span class="timestamp">[${new Date().toISOString()}]</span> 
                        <span class="log-level-info">INFO</span> 
                        æ—¥å¿—å·²æ¸…ç©ºï¼Œç­‰å¾…æ–°çš„æ—¥å¿—è§¦å‘...
                    </div>
                `;
                logCounter = 1;
            }
            
            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
            window.onload = function() {
                checkStatus();
                
                // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
                setInterval(checkStatus, 30000);
                
                // æ·»åŠ æ¬¢è¿æ—¥å¿—
                setTimeout(() => {
                    addLogEntry('info', 'ğŸ‰ æ¬¢è¿ä½¿ç”¨ EKS æ—¥å¿—é‡‡é›†æµ‹è¯•ç³»ç»Ÿï¼');
                    addLogEntry('info', 'ğŸ“¡ ç³»ç»Ÿå·²è¿æ¥åˆ° Fluent-bit æ—¥å¿—é‡‡é›†å™¨');
                    addLogEntry('info', 'ğŸ” æ—¥å¿—å°†è¢«å‘é€åˆ° OpenSearch è¿›è¡Œå­˜å‚¨å’Œåˆ†æ');
                }, 1000);
            };
        </script>
    </body>
    </html>
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: log-script
  namespace: logs-collect
data:
  log-generator.sh: |
    #!/bin/sh
    
    # ç”Ÿæˆç»“æ„åŒ–æ—¥å¿—çš„è„šæœ¬
    while true; do
        # ç”Ÿæˆä¸åŒçº§åˆ«çš„æ—¥å¿—
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
        LEVELS=("INFO" "WARN" "ERROR" "DEBUG")
        LEVEL=${LEVELS[$((RANDOM % 4))]}
        
        # ç”Ÿæˆéšæœºæ¶ˆæ¯
        MESSAGES=(
            "User authentication successful"
            "Database connection established"
            "Processing user request"
            "Cache miss occurred"
            "API request completed"
            "Background job started"
            "Configuration loaded"
            "Health check performed"
            "Log collection system active"
            "Fluent-bit processing logs"
            "OpenSearch indexing data"
            "EKS cluster monitoring"
        )
        MESSAGE=${MESSAGES[$((RANDOM % 12))]}
        
        # è¾“å‡ºJSONæ ¼å¼æ—¥å¿—
        echo "{\"timestamp\":\"$TIMESTAMP\",\"level\":\"$LEVEL\",\"app\":\"log-generator\",\"message\":\"$MESSAGE\",\"request_id\":\"req-$(date +%s)-$RANDOM\",\"user_id\":\"user-$((RANDOM % 1000))\",\"cluster\":\"logs-collect-cluster\",\"namespace\":\"logs-collect\"}"
        
        # éšæœºé—´éš” 2-8 ç§’
        sleep $((2 + RANDOM % 7))
    done
---
apiVersion: v1
kind: Service
metadata:
  name: log-generator-service
  namespace: logs-collect
  labels:
    app: log-generator
spec:
  selector:
    app: log-generator
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
  type: ClusterIP
